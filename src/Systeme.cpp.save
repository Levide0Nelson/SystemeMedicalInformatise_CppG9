#include "Systeme.h"
#include <iostream>
#include <sstream>
#include <fstream>
#include <limits>

Systeme::Systeme() : m_nextIdPatient(1),/* m_nextIdConsultation(1), m_nextIdAntecedent(1),*/ m_utilisateurConnecte(nullptr)
{

}

// ----Gestion de l'authentification-----
Utilisateur* Systeme::authentifier(const std::string& username, const std::string& password)
{
    for (auto& admin : m_admins)
    {
        if (admin.getLogin() == username && admin.verifierMotDePasse(password))
        {
            m_utilisateurConnecte = &admin;
            return m_utilisateurConnecte;
        }
    }
    for (auto& pro : m_professionnels)
    {
        if (pro.getLogin() == username && pro.verifierMotDePasse(password))
        {
            m_utilisateurConnecte = &pro;
            return m_utilisateurConnecte;
        }
    }
    return nullptr;
}

        // ----Persistance des données ---
void Systeme::chargerDonnes()
{
    std::cout << "[Chargement des données des administrateurs ...]\n";
    chargerAdmins();
    std::cout << "[Chargement des données des professionnels de santé...]\n";
    chargerProfessionnels();
    std::cout << "[SUCCES DU CHARGEMENT] Toutes les données ont été chargées.\n" << std::endl;
}

void Systeme::chargerAdmins()
{
    std::ifstream fichier(FICHIER_ADMINS);
    bool premiereConnexion = false;

    if (fichier.is_open())
    {
        std::string ligne;

        while (std::getline(fichier, ligne))
        {
            if (ligne.empty())
                continue;
            std::stringstream ss(ligne);
            std::string idStr, nom, prenom, login, password, role;

            std::getline(ss, idStr, ';');
            std::getline(ss, nom, ';');
            std::getline(ss, prenom, ';');
            std::getline(ss, login, ';');
            std::getline(ss, password, ';');
            std::getline(ss, role, ';');

            int id = std::stoi(idStr);
            Administrateur admin(id,nom,prenom,login, password, false);
            m_admins.push_back(admin);

            // Mise à jour du prochain ID
            if (id >= m_nextIdPatient)
                m_nextIdPatient = id +1;
        }
        fichier.close();
        std::cout << "[OK] " << m_admins.size() << " administrateur(s) chargé(s).\n";
    }
    else
    {
        std::cout << "[ATTENTION !] Fichier admins.csv non trouvé. Création nouvelle base de sauvegarde.\n" << std::endl;
        premiereConnexion = true;
    }

    if (m_admins.empty() || premiereConnexion)
    {
        std::cout << "[INFO] Création du premier administrateur système requis.\n";
        std::string nom, prenom, login, password;
        std::cout << "Nom : ";
        std::getline(std::cin, nom);
        std::cout << "Prénom : ";
        std::getline(std::cin, prenom);
        std::cout << "Login/Username : ";
        std::getline(std::cin, login);
        std::cout << "Password : ";
        std::getline(std::cin, password);

        Administrateur admin(m_nextIdPatient++, nom, prenom, login, password);
        m_admins.push_back(admin);
        std::cout << "[SUCCES] Premier administrateur créé.\n";
        std::cout << "Bienvenu sur le système.\n";

        // Sauvegarde automatique :
        sauvegarderAdmins();
    }
}
void Systeme::chargerProfessionnels()
{
    std::ifstream fichier(FICHIER_PROFESSIONNELS);
    if (fichier.is_open())
    {
        std::string ligne;

        while (std::getline(fichier, ligne))
        {
            if (ligne.empty())
                continue;
            std::stringstream ss(ligne);
            std::string idStr, nom, prenom, login, password, role, specialite, grade;

            std::getline(ss, idStr, ';');
            std::getline(ss, nom, ';');
            std::getline(ss, prenom, ';');
            std::getline(ss, login, ';');
            std::getline(ss, password, ';');
            std::getline(ss, role, ';');
            std::getline(ss, specialite, ';');
            std::getline(ss, grade, ';');

            int id = std::stoi(idStr);
            ProfessionnelSante pro(id, nom, prenom, login, password, role, specialite, grade);
            m_professionnels.push_back(pro);

            if (id >= m_nextIdPatient)
                m_nextIdPatient = id +1;
        }
        fichier.close();
        std::cout << "[OK] " << m_professionnels.size() << " professionnel(s) de santé chargé(s).\n";
    }
    else
        std::cout << "[ATTENTION !] Fichier professionnels.csv non trouvé.\n" << std::endl;
}


void Systeme::sauvegarderDonnees() const
{
    std::cout << "[Sauvegarde des données...]\n";
    sauvegarderAdmins();
    sauvegarderProfessionnels();
    std::cout << "[SUCCES] Toutes les données ont été sauvegardées.\n";
}

void Systeme::sauvegarderAdmins() const
{
    std::ofstream fichier(FICHIER_ADMINS);
    for (const auto& admin : m_admins)
    {
        fichier << admin.toCSV() << "\n";
    }
    fichier.close();
    std::cout << "[OK] Admins sauvegardés.\n" << std::endl;
}
void Systeme::sauvegarderProfessionnels() const
{
    std::ofstream fichier(FICHIER_PROFESSIONNELS);
    for (const auto& pro : m_professionnels)
    {
        fichier << pro.toCSV() << "\n";
    }
    fichier.close();
    std::cout << "[OK] Professionnels de santé sauvegardés.\n" << std::endl;
}


        // ----Gestion des utilisateurs ---
void Systeme::ajouterAdministrateur(const Administrateur& admin)
{
    m_admins.push_back(admin);
}
void Systeme::ajouterProfessionnel(const ProfessionnelSante& pro)
{
    m_professionnels.push_back(pro);
}
Administrateur* Systeme::rechercherAdmin(const std::string& username)
{
    for (auto& admin : m_admins)
        if (admin.getLogin() == username)
            return &admin;
    return nullptr;
}
ProfessionnelSante* Systeme::rechercherPro(const std::string& username)
{
    for (auto& pro : m_professionnels)
        if (pro.getLogin() == username)
            return &pro;
    return nullptr;
}



        // ----Affichage des stats
void Systeme::afficherStatistiques() const
{
    //std::cout << "Nombre de patients : " << m_patients.size() << std::endl;
    std::cout << "Nombre de professionnels : " << m_professionnels.size() << std::endl;
    std::cout << "Nombre d'administrateurs : " << m_admins.size() << std::endl;
    int nbConsult = 0, nbAnt = 0;

    /*for (const auto& dossier : m_dossiers)
    {
        nbConsult += dossier.getConsultations().size();
        nbAnt += dossier.getAntecedents().size();
    }
    std::cout << "Nombre total de consultations : " << nbConsult << std::endl;
    std::cout << "Nombre total d'antécédents : " << nbAnt << std::endl;*/
}

        // ---Menu principal----
void Systeme::lancerMenu()
{
    if (!m_utilisateurConnecte)
    {
        std::cout << "Aucun utilisateur authentifié. Veuillez vous connecter.\n";
        return;
    }

    bool quitter = false;

    while(!quitter)
    {
        m_utilisateurConnecte -> afficherMenu();
        std::cout << "Votre choix : ";
        int choix;
        std::cin >> choix;
        if (std::cin.fail())
        {
             std::cin.clear();

            std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n');
            std::cout << "[ERREUR] Entrée invalide, veuillez entrer un chiffre." << std::endl;
            continue;
        }
        std::cin.ignore();

        // Dispatcing des fonctions métiers selon le rôle/menu
        if (m_utilisateurConnecte -> getRole() == "Administrateur")
        {
            switch (choix)
            {
                case 1 :
                    menuGestionUtilisateurs();
                    break;
                case 2 : // Inscription patient
                    menuInscriptionPatient();
                    break;
                case 3:
                    //menuConsultationDossier();
                    break;
                case 4 :
                    //menuArchivageDossiers();
                    break;
                case 5 :
                    afficherDossiersArchives();
                    break;
                case 6 :
                    afficherStatistiques();
                    break;
                case 8 :
                    quitter = true;
                    std::cout << "Déconnexion administrateur...\n";
                    break;
                default:
                    std::cout << "[ERREUR] Choix invalide.\n";
                    break;
            }
        }
        else
        {
            switch (choix)
            {
                case 1 :
                    //afficherTousPatients();
                case 2 :
                    //menuRechercherPatient();
                    break;
                case 3 :
                    //menuConsultationDossier();
                    break;
                case 4:
                    //menuCreerConsultation();
                    break;
                case 5:
                    //menuAjouterAntecedent();
                    break;
                case 7 :
                    //menuAjouterPrescriptions();
                    break;
                case 9 :
                    quitter = true;
                    std::cout << "Déconnexion professionnel...\n";
                    break;
                default :
                    std::cout << "[ERREUR] Choix invalide.\n";
                    break;
            }
        }
    }
}

        // utilitaires internes
int Systeme::genererIdPatient()
{
    return m_nextIdPatient++;
}
int Systeme::genererIdConsultation()
{
    return m_nextIdConsultation++;
}
int Systeme::genererIdAntecedent()
{
    m_nextIdAntecedent++;
}

    // Menu administrateur
void Systeme::menuGestionUtilisateurs()
{
    bool sortir = false;

    while (!sortir)
    {
        std::cout << "\n==== Gestion des Utilisateurs ====\n";
        std::cout << "1. Créer un administrateur\n";
        std::cout << "2. Créer un professionnel de santé\n";
        std::cout << "3. Lister tous les utilisateurs\n";
        std::cout << "4. Retour au menu principal\n";
        std::cout << "Votre choix : ";
        int choix;
        std::cin >> choix;
        std::cin.ignore();

        switch (choix)
        {
            case 1 :
            {
                std::string nom, prenom, login, password;
                std::cout << "Nom du nouvel Administrateur : ";
                std::getline(std::cin, nom);
                std::cout << "Prénom du nouvel Administatrateur : ";
                std::getline(std::cin, prenom);
                std::cout << "Username/Login : ";
                std::getline(std::cin, login);
                std::cout << "Password : ";
                std::getline(std::cin, password);

                Administrateur admin(genererIdPatient(), nom, prenom, login, password, false);
                ajouterAdministrateur(admin);
                std::cout << "[SUCCES] Nouvel Administrateur créé.\n";
                sauvegarderAdmins();
                break;
            }

            case 2:
                {
                    std::string nom, prenom, login, password, role, specialite, grade;
                    std::cout << "Nom : ";
                    std::getline(std::cin, nom);
                    std::cout << "Prénom : ";
                    std::getline(std::cin, prenom);
                    std::cout << "Username : ";
                    std::getline(std::cin, login);
                    std::cout << "Password : ";
                    std::getline(std::cin, password);
                    std::cout << "Rôle (medecin/infirmier/pharmacien) : "; std::getline(std::cin, role);
                    std::cout << "Spécialité : ";
                    std::getline(std::cin, specialite);
                    std::cout << "Grade : ";
                    std::getline(std::cin, grade);

                    ProfessionnelSante pro(genererIdPatient(), nom, prenom, login, password, role, specialite, grade);
                    ajouterProfessionnel(pro);
                    std::cout << "[SUCCES] Nouveau Professionnel créé.\n";
                    sauvegarderProfessionnels();
                    break;
                }
            case 3:
                {
                    std::cout << "\n\t---- Administrateur ----\n";
                    for (const auto& admin : m_admins)
                    {
                        std::cout << "ID : " << admin.getIdUser() << " | " << admin.getNom() << " " << admin.getPrenom() << " ("
                                  << admin.getLogin() << ")\n";
                    }

                    std::cout << "\n\t---- Professionnel de Santé ----\n";
                    for (const auto& pro : m_professionnels)
                    {
                        std::cout << "ID : " << pro.getIdUser() << " | " << pro.getNom() << " " << pro.getPrenom() << " | Rôle : "
                                  << pro.getRole() << " | Spécialité : " << pro.getSpecialite() << "\n";
                    }
                    break;
                }
            case 4 :
                {
                    sortir = true;
                    break;
                }
            default :
                std::cout << "[ERREUR] Choix invalide.\n";
        }
    }
}
// Menu administrateur : Inscription d'un patient
void Systeme::menuInscriptionPatient()
{
    std::string nom, prenom, dateNaissance, genre, adresse, telephone, email;
    std::cout << "\n===== Inscription d'un Patient =====\n";
    std::cout << "Nom : ";
    std::getline(std::cin, nom);
    std::cout << "Prénom : ";
    std::getline(std::cin, prenom);
    std::cout << "Date de naissance (YYYY-MM-DD) : ";
    std::getline(std::cin, dateNaissance);
    std::cout << "Genre (M/F/A) : ";
    std::getline(std::cin, genre);
    std::cout << "Adresse : ";
    std::getline(std::cin, adresse);
    std::cout << "Téléphone : ";
    std::getline(std::cin, telephone);
    std::cout << "Email : ";
    std::getline(std::cin, email);

    int idPatient = m_nextIdPatient++;

    Patient patient(idPatient, nom, prenom, dateNaissance, genre, adresse, telephone, email);
    creerPatient(patient);
    std::cout << "[SUCCES] Patient inscrit.\n ID du nouveau patient: " << idPatient << "\n";
}


void Systeme::menuArchivageDossiers()
{
    std::cout << "\n===== Archivage d'un dossier patient =====\n";
    int idPatient;
    std::cout << "Entrer l'ID du patient à archiver : ";
    std::cin >> idPatient;
    std::cin.ignore();
    DossierMedical* dossier = rechercherDossier(idPatient);

    if (!dossier)
    {
        std::cout << "[ERREUR] Dossier non trouvé !\n";
        return;
    }
    if (dossier -> estArchive())
    {
        std::cout << "[INFO] Ce dossier est déjà archivé.\n";
        return;
    }
    dossier->setArchive(true);
    std::cout << "[SUCCES] Dossier du patient #" << idPatient << " archivé.\n";
}

void Systeme::afficherDossiersArchives() const
{
    std::cout << "\n===== Dossiers archivés =====\n";
    for (const auto& dossier : m_dossiers)
    {
        if (dossier.estArchive())
        {
            std::cout << "Patient #" << dossier.getIdPatient() << "\n";
            dossier.afficherResumeDossier();
            std::cout << "--------------------------\n" << std::endl;
        }
    }
}
